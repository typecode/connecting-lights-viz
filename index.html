<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Prototyping</title>
		<link rel="stylesheet" href="static/css/reset.css">
		<link rel="stylesheet" href="static/css/booklr.css">
		<link rel="stylesheet" href="static/css/connected_lights.css">

		<!-- Type/Code Libraries -->
		<script type='text/javascript' src='static/js/lib/typecode-js/lib/tc.seed.js'></script>

		<!-- Application Page -->
		<script type='text/javascript'>
			window.console = NI.app.getConsole(true);
			window.page = {
				modules: {},
				features: []
			};
			window.onunload = function(){}; // fixes back-button problems in safari and ff
		</script>


	</head>

	<body>
		<div id='application' class="app-wrap"></div>

		<p id='n-particles'></p>

		<!-- jQuery & Other Libraries -->
		<script src='static/js/lib/jquery-1.7.2.min.js'></script>

		<!-- d3.js -->
		<script src='static/js/lib/d3/d3.v2.js'></script>

		<!-- three.js -->
		<script src='static/js/lib/three.js/build/Three.js'></script>

		<!-- threex 
		<script src='static/js/lib/threex/threex.domevent.js'></script>
		<script src='static/js/lib/threex/threex.domevent.object3d.js'></script> -->

		<!-- d3-threeD -->
		<script src='static/js/lib/d3-threeD/lib/d3-threeD.js'></script>

		<!-- leaflet -->
		<script src='static/js/lib/leaflet/dist/leaflet.js'></script>
		<link rel="stylesheet" href="static/js/lib/leaflet/dist/leaflet.css">

		<!-- leaflet: TileLayer.TileJSON.js -->
		<script src='static/js/lib/TileLayer.TileJSON.js'></script>

		<!-- leaflet: Mapbox.Waxjs -->
		<script src='static/js/lib/mapbox-wax/dist/wax.leaf.js'></script>

		<!-- stats.js -->
		<script src='static/js/lib/stats.js/build/Stats.js'></script>

		<!-- geo-util from http://www.smartjava.org/examples/threed3s/ -->
		<script src='static/js/lib/geo-util.js'></script>

		<!-- Type/Code Libraries -->
		<script src='static/js/lib/typecode-js/lib/tc.app.js'></script>
		<script src='static/js/lib/typecode-js/lib/tc.overlay.js'></script>

		<!-- Site-wide Application Modules -->

		<!-- Application -->
		<script type='text/javascript'>

		</script>
		
		<!-- Application -->
		<script type='text/javascript'>

			var Viz_Two = function(options) {
					
				var o, internal, elements, fn, handlers;
				
				o = $.extend({
					app:null,
					$e:null,
					selector:'',
					width: 600,
					height: 600,
					tileSize: 256,
					buffer: 5
				}, options);
				
				internal = {
					name:'Module.Viz_Two',
					$e:(o.$e ? o.$e : $(o.selector)),
					particles: [],
					animation_frame_id:null,
					point_mapper:{
						n_points: null,
						points:[
							[-3.21379, 54.9536],
							[-3.21158, 54.9539],
							[-3.20897, 54.9529],
							[-3.20064, 54.9494],
							[-3.19654, 54.9492],
							[-3.19462, 54.9491],
							[-3.18691, 54.9493],
							[-3.18236, 54.9439],
							[-3.18064, 54.9416],
							[-3.17779, 54.9405],
							[-3.17361, 54.9401],
							[-3.17073, 54.9401],
							[-3.16297, 54.9384],
							[-3.16155, 54.935],
							[-3.1594, 54.9312],
							[-3.15762, 54.9295],
							[-3.1552, 54.9292],
							[-3.14558, 54.9282],
							[-3.09383, 54.9264],
							[-3.08945, 54.9262],
							[-3.08023, 54.9246],
							[-3.06413, 54.9217],
							[-3.05016, 54.9226],
							[-3.04824, 54.9225],
							[-3.04609, 54.9221],
							[-3.02626, 54.9243],
							[-3.01908, 54.9243],
							[-3.01839, 54.9242],
							[-3.01358, 54.9222],
							[-3.01271, 54.9215],
							[-3.01181, 54.9203],
							[-3.01089, 54.9185],
							[-3.00884, 54.9163],
							[-3.00375, 54.9153],
							[-3.00294, 54.915],
							[-3.0022, 54.9147],
							[-3.00056, 54.9144],
							[-2.9978, 54.9131],
							[-2.99166, 54.9141],
							[-2.99076, 54.9139],
							[-2.98571, 54.9109],
							[-2.98515, 54.9092],
							[-2.98387, 54.9078],
							[-2.98308, 54.9063],
							[-2.98176, 54.9045],
							[-2.98034, 54.9029],
							[-2.97977, 54.9024],
							[-2.97798, 54.9015],
							[-2.97473, 54.9004],
							[-2.97137, 54.8998],
							[-2.96631, 54.8989],
							[-2.96574, 54.8988],
							[-2.95867, 54.8988],
							[-2.9496, 54.9004],
							[-2.94075, 54.9022],
							[-2.93739, 54.9044],
							[-2.93302, 54.9073],
							[-2.92423, 54.9128],
							[-2.91928, 54.9158],
							[-2.91638, 54.9177],
							[-2.90131, 54.9233],
							[-2.89369, 54.9259],
							[-2.88504, 54.9314],
							[-2.8802, 54.9347],
							[-2.8783, 54.9351],
							[-2.87526, 54.9356],
							[-2.8738, 54.9358],
							[-2.8339, 54.9429],
							[-2.81052, 54.9476],
							[-2.8005, 54.9481],
							[-2.79877, 54.9482],
							[-2.78583, 54.9555],
							[-2.78258, 54.9564],
							[-2.78063, 54.9579],
							[-2.77425, 54.9632],
							[-2.76648, 54.9672],
							[-2.74679, 54.9718],
							[-2.73497, 54.9716],
							[-2.73235, 54.972],
							[-2.71087, 54.9721],
							[-2.69249, 54.9739],
							[-2.68338, 54.9744],
							[-2.67224, 54.974],
							[-2.65613, 54.9778],
							[-2.63715, 54.9826],
							[-2.63257, 54.9841],
							[-2.61723, 54.9871],
							[-2.60256, 54.9904],
							[-2.59952, 54.9907],
							[-2.59492, 54.991],
							[-2.5879, 54.9919],
							[-2.57936, 54.9897],
							[-2.57727, 54.9897],
							[-2.57391, 54.9892],
							[-2.56456, 54.9896],
							[-2.55262, 54.9883],
							[-2.54537, 54.9879],
							[-2.53869, 54.9879],
							[-2.52994, 54.9879],
							[-2.52046, 54.9876],
							[-2.5163, 54.9885],
							[-2.51199, 54.9906],
							[-2.50627, 54.9929],
							[-2.50202, 54.9936],
							[-2.4981, 54.9943],
							[-2.49308, 54.9956],
							[-2.48717, 54.9963],
							[-2.48133, 54.9951],
							[-2.47856, 54.9956],
							[-2.4766, 54.9954],
							[-2.47044, 54.9953],
							[-2.46392, 54.9955],
							[-2.46147, 54.9956],
							[-2.45772, 54.9952],
							[-2.45171, 54.993],
							[-2.44595, 54.9942],
							[-2.44156, 54.9949],
							[-2.43751, 54.9954],
							[-2.43609, 54.9952],
							[-2.43557, 54.9956],
							[-2.43274, 54.9959],
							[-2.43006, 54.9957],
							[-2.42594, 54.9964],
							[-2.4223, 54.9977],
							[-2.41717, 54.9987],
							[-2.41293, 54.9991],
							[-2.41004, 55.0009],
							[-2.40543, 55.0018],
							[-2.40074, 55.0023],
							[-2.39914, 55.0022],
							[-2.38953, 55.0023],
							[-2.38795, 55.0013],
							[-2.38661, 55.0015],
							[-2.3855, 55.0023],
							[-2.37959, 55.0031],
							[-2.37885, 55.0035],
							[-2.37736, 55.0038],
							[-2.3746, 55.0034],
							[-2.37025, 55.0049],
							[-2.36653, 55.0052],
							[-2.35808, 55.0059],
							[-2.35513, 55.0095],
							[-2.35223, 55.0105],
							[-2.34053, 55.0125],
							[-2.33934, 55.0121],
							[-2.33766, 55.0123],
							[-2.3358, 55.0131],
							[-2.32955, 55.0138],
							[-2.32833, 55.0149],
							[-2.32521, 55.0166],
							[-2.31742, 55.0184],
							[-2.31463, 55.0244],
							[-2.31363, 55.0248],
							[-2.29704, 55.0272],
							[-2.29618, 55.0279],
							[-2.28847, 55.0289],
							[-2.27883, 55.0294],
							[-2.26985, 55.0308],
							[-2.26322, 55.0312],
							[-2.25521, 55.032],
							[-2.21622, 55.0363],
							[-2.20012, 55.0378],
							[-2.19804, 55.0386],
							[-2.19517, 55.0388],
							[-2.16156, 55.0314],
							[-2.15799, 55.0306],
							[-2.14019, 55.0262],
							[-2.13373, 55.0248],
							[-2.10496, 55.0196],
							[-2.07271, 55.0192],
							[-2.0321, 55.0142],
							[-2.00697, 55.0108],
							[-1.99209, 55.0114],
							[-1.9815, 55.0131],
							[-1.9723, 55.0129],
							[-1.94996, 55.0116],
							[-1.93134, 55.0103],
							[-1.9077, 55.0085],
							[-1.88062, 55.0094],
							[-1.84369, 55.0037],
							[-1.83432, 55.0038],
							[-1.79414, 54.9977],
							[-1.78325, 54.9964],
							[-1.76079, 54.996],
							[-1.74743, 54.9958],
							[-1.73627, 54.9935],
							[-1.72455, 54.9913],
							[-1.71493, 54.9892],
							[-1.70558, 54.9874],
							[-1.69573, 54.9854],
							[-1.6889, 54.9837],
							[-1.66357, 54.9772],
							[-1.63033, 54.9719],
							[-1.61399, 54.9696],
							[-1.58994, 54.9758],
							[-1.57651, 54.9776],
							[-1.57063, 54.9788],
							[-1.53999, 54.9861],
							[-1.5327, 54.9881],
							[-1.52729, 54.9858]
						]
					}
				};

				elements = {
					window: $(window),
					map: null,
					n_particles: $('#n-particles')
				};

				fn = {
					init: function(){
						internal.stats = new Stats();
						internal.stats.setMode(0); // 0: fps, 1: ms
						internal.stats.domElement.style.position = 'absolute';
						internal.stats.domElement.style.right = '0px';
						internal.stats.domElement.style.top = '0px';
						document.body.appendChild( internal.stats.domElement );


						internal.$e.css({
							'height': o.height + 'px',
							'width': o.width + 'px'
						});

						internal.map = L.map('application');

						fn.prepare_point_mapper();
						fn.generate_particles(500);

						wax.tilejson('http://a.tiles.mapbox.com/v3/zlieberm.ConnectingLights.jsonp', function(tilejson) {
							var wax_leaf;
							wax_leaf = new wax.leaf.connector(tilejson);
							wax_leaf.addTo(internal.map);
						});

						internal.map.setView([54.9839, -2.3291], 10);


					//	internal.canvasTiles = new L.TileLayer.Canvas({});
					//	internal.canvasTiles.drawTile = fn.drawTile;
					//	internal.canvasTiles.addTo(internal.map);
					//	internal.canvasTiles.bringToFront();

					},

					prepare_point_mapper: function(){
						var i, total_distance, distance_thus_far;
						internal.point_mapper.n_points = internal.point_mapper.points.length;
						total_distance = 0;
						for(i = 0; i < internal.point_mapper.n_points; i++){
							if(i > 0){
								total_distance += fn.distance(internal.point_mapper.points[i-1], internal.point_mapper.points[i]);
							}
						}
						distance_thus_far = 0;
						for(i = 0; i < internal.point_mapper.n_points; i++){
							if(i > 0){
								distance_thus_far += fn.distance(internal.point_mapper.points[i-1], internal.point_mapper.points[i]);
							}
							internal.point_mapper.points[i].push(distance_thus_far/total_distance);
						}
					},

					distance: function(point1, point2){
						var xs, ys;
						
						xs = point2[0] - point1[0];
						xs = xs * xs;
						
						ys = point2[1] - point1[1];
						ys = ys * ys;
						
						return Math.sqrt( xs + ys );
					},

					generate_particles: function(n_particles){
						var i, my_color, my_particle;

						for(i = 0; i < n_particles; i++){
							my_color = (new d3.hsl((Math.random()*360), 1, 0.60)).rgb();
							my_particle = {
								color: 'rgba('+my_color.r+','+my_color.g+','+my_color.b+','+0.6+')',
								lat_lng: null,
								position_on_line: Math.random(0),
								velocity: (Math.random() * 0.00001),
								layer: null
							};
							my_particle.lat_lng = fn.map_position(my_particle.position_on_line);
							my_particle.layer = L.circle(my_particle.lat_lng, 300, {
									stroke: false,
									fillColor: my_particle.color,
									fillOpacity: 0.75
								}
							).addTo(internal.map);
							console.log(my_particle.layer);
							internal.particles.push(my_particle);
						}
					},

					update_particles: function(){
						var i, my_particle;
						for(i = 0; i < internal.particles.length; i++){
							my_particle = internal.particles[i];
							my_particle.position_on_line = my_particle.position_on_line + my_particle.velocity;
							if(my_particle.position_on_line < 0 || my_particle.position_on_line > 1){
								my_particle.velocity = my_particle.velocity * -1;
								if(my_particle.position_on_line < 0){
									my_particle.position_on_line = 0;
								}
								if(my_particle.position_on_line > 1){
									my_particle.position_on_line = 1;
								}
							}
							my_particle.lat_lng = fn.map_position(my_particle.position_on_line);
							my_particle.layer.setLatLng(my_particle.lat_lng);
						}
					},
					
					map_position: function(pct){
						var i, lat_lng, points, pta, ptb;

						points = internal.point_mapper.points;

						for(i = 0; i < (internal.point_mapper.n_points - 1); i++){
							if( pct >= internal.point_mapper.points[i][2] && pct <= internal.point_mapper.points[i+1][2]){
								pta = i;
								ptb = i + 1;
								break;
							}
						}

						if(points[pta] && points[ptb]){
							pct_between = (pct - points[pta][2]) / (points[ptb][2] - points[pta][2]);
							
							lat_lng = new L.LatLng(
								points[pta][1] + ((pct_between) * (points[ptb][1] - points[pta][1])),
								points[pta][0] + ((pct_between) * (points[ptb][0] - points[pta][0]))
							);						
						} else {
							lat_lng = new L.LatLng(
								points[pta][1],
								points[pta][0]
							);						
						}
						return lat_lng;
						

						
					},

					drawTile: function(canvas, tilePoint, zoom){

						var ctx, bounds, particles_to_draw, i, my_image_data;

						ctx = {
							map: this._map,
							canvas: canvas,
							context: canvas.getContext('2d'),
							tile: tilePoint,
							zoom: zoom
						};

						bounds = fn.get_canvas_bounds(ctx, o.buffer);
						particles_to_draw = fn.get_particles_for_bounds(bounds);

						ctx.context.clearRect (0,0, ctx.canvas.width, ctx.canvas.height);
						for(i = 0; i < particles_to_draw.length; i++){
							fn.draw_particle(ctx, particles_to_draw[i]);

						}
					},

					get_canvas_bounds: function(ctx, buf){
						//potentially a slow function - look at caching it on the canvas object?


						var nwPoint, sePoint, diff, nwCoord, seCoord, swLatLng, neLatLng, bounds;
					
						nwPoint = ctx.tile.multiplyBy(o.tileSize);
						sePoint = nwPoint.add(new L.Point(o.tileSize, o.tileSize));

						// optionally, enlarge request area.
						// with this I can draw points with coords outside this tile area,
						// but with part of the graphics actually inside this tile.
						// NOTE: that you should use this option only if you're actually drawing points!
						if (buf > 0) {
							diff = new L.Point(buf, buf);
							nwPoint = nwPoint.subtract(diff);
							sePoint = sePoint.add(diff);
						}

						nwCoord = ctx.map.unproject(nwPoint, ctx.zoom, true);
						seCoord = ctx.map.unproject(sePoint, ctx.zoom, true);

						swLatLng = new L.LatLng(seCoord.lat, nwCoord.lng);
						neLatLng = new L.LatLng(nwCoord.lat, seCoord.lng);
						bounds = new L.LatLngBounds(swLatLng, neLatLng);
						
						return bounds;
					},

					get_particles_for_bounds: function(bounds){
						var i, output;
						output = [];
						for(i = 0; i < internal.particles.length; i++){
							
							if(internal.particles[i].lat_lng && bounds.contains(internal.particles[i].lat_lng)){
								output.push(internal.particles[i]);
							}
						}
						return output;
					},

					draw_particle: function(ctx, particle){
						var style, geom, i;
						style = {
							color: particle.color,
							radius: 5
						};
						geom = particle.lat_lng;
						fn.draw_dot(style, ctx, geom);
					},

					draw_dot: function(style, ctx, geom){
						var p, c, g;
						p = this.get_tile_point(ctx, geom);
						c = ctx.canvas;
						g = ctx.context;
						g.beginPath();
						g.fillStyle = style.color;
						g.arc(p.x, p.y, style.radius, 0, Math.PI * 2);
						g.closePath();
						g.fill();
						g.restore();
					},

					get_tile_point: function(ctx, coords){
						// start coords to tile 'space'
						var s = ctx.tile.multiplyBy(o.tileSize);

						// actual coords to tile 'space'
						var p = ctx.map.project(coords);

						// point to draw
						var x = Math.round(p.x - s.x);
						var y = Math.round(p.y - s.y);
						return {
							x: x,
							y: y
						};
					},

					add_json_layers: function(){
						if(o.draw_hadrians_wall){
							jQuery.getJSON('static/data/hadrians-wall.json', function(d){
								L.geoJson(d, {
									style: function (feature) {
										return {
											"color": "#ff7800",
											"weight": 5,
											"opacity": 0.65
										};
									},
									onEachFeature: function (feature, layer) {
										layer.bindPopup(feature.properties.description);
									}
								}).addTo(internal.map);
							});
						}
							

						if(o.draw_balloons){
							jQuery.getJSON('static/data/balloons/output.json', function(d){
								L.geoJson(d, {
									style: function (feature) {
										return {
											"color": "#ff7800",
											"weight": 5,
											"opacity": 0.65
										};
									},
									onEachFeature: function (feature, layer) {
										layer.bindPopup(feature.properties.description);
									}
								}).addTo(internal.map);
							});
						}
					},

					animate: function(frame_time){
						var delta;
						delta = frame_time - internal.last_frame;
						internal.last_frame = frame_time;
						internal.stats.begin();
						internal.animation_frame_id = requestAnimationFrame( fn.animate );
						fn.draw(delta);
					},

					draw: function(){
						fn.update_particles();
						//internal.canvasTiles.redraw();
						//internal.canvasTiles.bringToFront();
						internal.stats.end();
						elements.n_particles.text(internal.particles.length);
					}
				};

				handlers = {
					keypress: function(e, d){
						console.log(e.which);
						if(e.which == 112){ // 'p'
							if(internal.animation_frame_id){
								cancelAnimationFrame(internal.animation_frame_id);
								internal.animation_frame_id = null;
							} else {
								internal.animation_frame_id = requestAnimationFrame(fn.animate);
							}
						} else if(e.which == 103){ // 'g'
							fn.generate_particles(10);
						}
					},
					resize: function(){
						internal.$e.css({
							'height': $(window).height() + 'px',
							'width': $(window).width() + 'px'
						});
					}
				};

				jQuery(window).bind('keypress', {}, handlers.keypress);
				jQuery(window).bind('resize', {}, handlers.resize);

				o.app.events.bind('app.featuresInitialized', {}, function(){
					fn.init();
					fn.animate();
				});
				
				console.log(internal);

			};

			window.page.features.push(function(app){
				app.runtime.viz = new Viz_Two({
					app: app,
					$e: $('#application'),
					width: $(window).width(),
					height: $(window).height()
				});
			});
			
			jQuery(document).bind('ready',function(){
				window.app = new NI.App({
					page: window.page
				});
			});
		</script>

	</body>
</html>
