<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Prototyping</title>
		<link rel="stylesheet" href="static/css/reset.css">
		<link rel="stylesheet" href="static/css/booklr.css">
		<link rel="stylesheet" href="static/css/connected_lights.css">

		<!-- Type/Code Libraries -->
		<script type='text/javascript' src='static/js/lib/typecode-js/lib/tc.seed.js'></script>

		<!-- Application Page -->
		<script type='text/javascript'>
			window.console = NI.app.getConsole(true);
			window.page = {
				modules: {},
				features: []
			};
			window.onunload = function(){}; // fixes back-button problems in safari and ff
		</script>


	</head>

	<body>
		<div id='application' class="app-wrap">
		
			<p id='animation-frame-id'></p>
		</div>

		<!-- jQuery & Other Libraries -->
		<script src='static/js/lib/jquery-1.7.2.min.js'></script>

		<!-- d3.js -->
		<script src='static/js/lib/d3/d3.v2.js'></script>

		<!-- three.js -->
		<script src='static/js/lib/three.js/build/Three.js'></script>

		<!-- d3-threeD -->
		<script src='static/js/lib/d3-threeD/lib/d3-threeD.js'></script>

		<!-- geo-util from http://www.smartjava.org/examples/threed3s/ -->
		<script src='static/js/lib/geo-util.js'></script>

		<!-- Type/Code Libraries -->
		<script src='static/js/lib/typecode-js/lib/tc.app.js'></script>
		<script src='static/js/lib/typecode-js/lib/tc.overlay.js'></script>

		<!-- Site-wide Application Modules -->

		<!-- Application -->
		<script type='text/javascript'>

		</script>
		
		
		<!-- Application -->
		<script type='text/javascript'>

			var Viz_One = function(options) {
					
				var o, internal, elements, fn, handlers;
				
				o = $.extend({
					app:null,
					$e:null,
					selector:'',
					width: 600,
					height: 600
				}, options);
				
				internal = {
					name:'Module.Viz_One',
					$e:(o.$e ? o.$e : $(o.selector)),

					renderer: null,
					camera: null,
					scene: null,
					controls: null,

					//camera position stuff
					view_angle: 45,//
					aspect: (o.width / o.height),
					near: 0.001,
					far: 100000,

					//scene stuff
					light: new THREE.PointLight(0xffffff),
					plane: {
						geo: new THREE.PlaneGeometry(100, 100, 10, 10),
						mat: new THREE.MeshLambertMaterial({color: 0xf4f4f4}),
						plane: null
					},

					uk_boundary: {
						material: new THREE.LineBasicMaterial({color: 0x00ff00}),
						geometry: [],
						meshes: []
					},

					wall: {
						material: new THREE.LineBasicMaterial({color: 0xff0000}),
						geometry: [],
						lines: []
					},

					balloons: {
						material: new THREE.MeshLambertMaterial({emissive: 0xf4f4f4}),
					},

					last_frame: 0
				};

				elements = {
					window: $(window),
					frame_id: $('#frame-id')
				};

				fn = {
					init: function(){
						internal.renderer = new THREE.CanvasRenderer();
						//internal.renderer.setClearColor({r:1, g:1, b:1}, 5);
						//internal.renderer = new THREE.WebGLRenderer({clearAlpha:1});
						internal.renderer.setSize(o.width, o.height);
						internal.$e.append(internal.renderer.domElement);

						internal.scene = new THREE.Scene();

						internal.camera = new THREE.PerspectiveCamera(internal.view_angle, internal.aspect, internal.near, internal.far);
						internal.camera.position.z = 0.03;
						internal.camera.position.x = -3.1;
						internal.camera.position.y = 54.927;
						
						internal.camera.lookAt(internal.scene.position);
						internal.scene.add(internal.camera);

						internal.light.position.x = 800;
						internal.light.position.y = 800;
						internal.light.position.z = 800;
						//internal.scene.add(internal.light);

						internal.plane.plane = new THREE.Mesh(internal.plane.geo, internal.plane.mat);
						internal.plane.plane.rotation.x = (Math.PI/2);
						//internal.scene.add(internal.plane.plane);

						internal.controls = new THREE.FirstPersonControls(internal.camera);
						internal.controls.movementSpeed = 0.0001;
						internal.controls.lookSpeed = 0.1;
						internal.controls.noFly = false;
						internal.controls.lookVertical = true;
					},

					add_origin: function(){
						internal.axis = new THREE.AxisHelper();
						internal.scene.add(internal.axis);
					},

					add_uk_boundary: function(){
						jQuery.getJSON('static/data/uk-boundary.json', function(d){
							var i, j, k, ii, my_feature, my_feature_intermediate_path, my_feature_path, my_feature_shape,
							my_feature_3d, my_f, my_ls, my_x, my_y, my_z, lat, lon, alt;

							internal.wall.material.linewidth = 2;

							for(i = 0; i < d.features.length; i++){
								my_feature = d.features[i];
								
								for(j = 0; j < my_feature.geometry.coordinates.length; j++){
									for(k = 0; k < my_feature.geometry.coordinates[j].length; k++){
										my_feature_geometry = new THREE.Geometry();
										for(ii = 0; ii < my_feature.geometry.coordinates[j][k].length; ii++){
											my_feature_geometry.vertices.push(new THREE.Vector3(
												my_feature.geometry.coordinates[j][k][ii][0],
												my_feature.geometry.coordinates[j][k][ii][1],
												0)
											);
										}
										internal.uk_boundary.geometry.push(my_feature_geometry);
									}
								}
							}

							for(i = 0; i < internal.uk_boundary.geometry.length; i++){
								internal.uk_boundary.meshes[i] = new THREE.Line(internal.uk_boundary.geometry[i], internal.uk_boundary.material);
								console.log(internal.uk_boundary.meshes[i]);
								internal.scene.add(internal.uk_boundary.meshes[i]);
							}

						});
					},

					add_wall: function(){
						jQuery.getJSON('static/data/hadrians-wall.json', function(d){
							var i, j, my_feature, my_feature_intermediate_path, my_feature_path, my_feature_shape,
							my_feature_3d, my_f, my_ls, my_x, my_y, my_z, lat, lon, alt;

							internal.wall.material.linewidth = 1;

							for(i = 0; i < d.features.length; i++){
								my_feature = d.features[i];
								my_feature_geometry = new THREE.Geometry();
								for(j = 0; j < my_feature.geometry.coordinates.length; j++){
									my_feature_geometry.vertices.push(new THREE.Vector3(
										my_feature.geometry.coordinates[j][0],
										my_feature.geometry.coordinates[j][1],
										0)
									);
								}
								internal.wall.geometry.push(my_feature_geometry);
							}

							for(i = 0; i < internal.wall.geometry.length; i++){
								internal.wall.lines[i] = new THREE.Line(internal.wall.geometry[i], internal.wall.material);
								internal.scene.add(internal.wall.lines[i]);
							}

						});
					},

					add_balloons: function(){
						jQuery.getJSON('static/data/S12.json', function(d){
							var i, my_feature, my_geometry, my_sphere;
							my_geometry = new THREE.SphereGeometry(0.0005, 6, 6);

							for(i = 0; i < d.features.length; i++){
								my_sphere = new THREE.Mesh(my_geometry, internal.balloons.material);
								my_sphere.position.x = d.features[i].geometry.coordinates[0];
								my_sphere.position.y = d.features[i].geometry.coordinates[1];
								internal.scene.add(my_sphere);
							}

						});
					},

					animate: function(frame_time){
						var delta;
						delta = frame_time - internal.last_frame;
						internal.last_frame = frame_time;
						internal.animation_frame_id = requestAnimationFrame( fn.animate );
						fn.draw(delta);
					},

					draw: function(delta){
						elements.frame_id.text(internal.animation_frame_id);
						internal.controls.update(delta);
						internal.renderer.render(internal.scene, internal.camera);
					}
				};

				handlers = {
					keypress: function(e, d){
						if(e.which == 112){ // 'p'
							if(internal.animation_frame_id){
								cancelAnimationFrame(internal.animation_frame_id);
								internal.animation_frame_id = null;
							} else {
								internal.animation_frame_id = requestAnimationFrame(fn.animate);
							}
						}
					},
					resize: function(){
						internal.renderer.setSize(elements.window.width(), elements.window.height());
						internal.camera.aspect = elements.window.width() / elements.window.height();
					}
				};

				jQuery(window).bind('keypress', {}, handlers.keypress);
				jQuery(window).bind('resize', {}, handlers.resize);

				o.app.events.bind('app.featuresInitialized', {}, function(){
					fn.init();
					fn.add_uk_boundary();
					fn.add_wall();
					fn.add_balloons();
					fn.animate();
					internal.renderer.setSize(elements.window.width(), elements.window.height());
					internal.camera.aspect = elements.window.width() / elements.window.height();
				});
				
				console.log(internal);

			};

			window.page.features.push(function(app){
				app.runtime.viz = new Viz_One({
					app: app,
					$e: $('#application'),
					width: $(window).width(),
					height: $(window).height()
				});
			});
			
			jQuery(document).bind('ready',function(){
				window.app = new NI.App({
					page: window.page
				});
			});
		</script>

	</body>
</html>
